{% extends 'base.html' %}
{% load static %}
{% block title %}BIT-Admin | Inventario{% endblock title %}

{% block content %}
    {% load customTagsInventario %}
    <div class="right_col" role="main">
        <div class="x_title">
            <h2><a href="{% url 'compras' %}">Compras »</a>
                <small><strong>Nueva Compras</strong></small>
            </h2>
            <ul class="nav navbar-right panel_toolbox"></ul>
            <div class="clearfix"></div>
        </div>
        <div  class="row">

            <div class="col-md-12 col-sm-12 col-xs-12">
                <div style="border-radius: 10px" class="x_panel">
                    <div class="col-md-6">
                        <div class="x_title">
                            <h2>Datos del Proveedor</h2>
                            <div class="clearfix"></div>
                        </div>

                        <div class="x_content">

                            <div class="form-horizontal form-label-left input_mask">

                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Tipo Documento:</label>
                                    <div class="col-md-8 col-xs-12">
                                        <select class="form-control col-md-7 col-xs-12 has-feedback-left" name="tipo" id="tipo">
                                            <option value="FACTURA">FACTURA</option>
                                            <option value="NOTA">NOTA DE VENTA</option>
                                            <option value="LIQUIDACION">LIQUIDACION DE COMPRA</option>
                                        </select>

                                        <span class="fa fa-credit-card form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Razon Social | Nombre Comercial
                                        :</label>
                                    <div class="col-md-8 col-xs-12">
                                        <div class="input-group">
                                            <input type="hidden" id="idproveedor" value="{{ proveedor.id }}">
                                            <input readonly style="border-radius: 5px;"
                                                   value="{{ proveedor.razonSocial }}"
                                                   class="form-control required"
                                                   id="nombrePro"
                                                   type="text">
                                            <span class="input-group-btn">
                                              <button type="button" data-toggle="modal"
                                                      data-target="#proveedores" class="btn bg-blue">
                                                  <i class="fa fa-user-plus"></i> PROVEEDOR
                                              </button>
                                        </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Identificacion Proveedor :</label>
                                    <div class="col-md-8 col-xs-12">
                                        <input readonly style="border-radius: 5px;"
                                               value="{{ proveedor.ruc }}"
                                               class="form-control col-md-7 col-xs-12 has-feedback-left"
                                               id="identificacion"
                                               required="required"
                                               type="text">
                                        <span class="fa fa-credit-card form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Direccion Proveedor:</label>
                                    <div class="col-md-8 col-xs-12">
                                        <input readonly style="border-radius: 5px "
                                               value="{{ proveedor.direccion }}"
                                               class="form-control col-md-7 col-xs-12 has-feedback-left"
                                               id="direccion"
                                               required="required"
                                               type="text">
                                        <span class="fa fa-map-marker form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Email Proveedor:</label>
                                    <div class="col-md-8 col-xs-12">
                                        <input readonly style="border-radius: 5px "
                                               value="{{ proveedor.email }}"
                                               class="form-control col-md-7 col-xs-12 has-feedback-left"
                                               id="email"
                                               required="required"
                                               type="email">
                                        <span class="fa fa-envelope-o form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6 col-xs-12">
                        <div class="x_title">
                            <h2>Datos de la factura de Compra</h2>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <div class="form-horizontal form-label-left input_mask">
                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Fecha Emision :</label>
                                    <div class="col-md-8 col-xs-12">
                                        <input style="border-radius: 5px;"
                                               class="form-control col-md-7 col-xs-12 has-feedback-left"
                                               id="fechaEmision" name="fechaEmision" required="required" type="date">
                                        <span class="fa fa-calendar form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>
                                 <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Numero Serie :</label>
                                    <div class="col-md-8 col-xs-12">
                                        <input style="border-radius: 5px;"
                                               class="form-control col-md-7 col-xs-12 has-feedback-left"
                                               id="serie" name="serie" required="required" type="text">
                                        <span class="fa fa-hashtag form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Numero Documento :</label>
                                    <div class="col-md-8 col-xs-12">
                                        <input style="border-radius: 5px;"
                                               class="form-control col-md-7 col-xs-12 has-feedback-left"
                                               id="secuencial" name="secuencial" required="required" type="text">
                                        <span class="fa fa-hashtag form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Numero Autorización :</label>
                                    <div class="col-md-8 col-xs-12">
                                        <input style="border-radius: 5px;"
                                               class="form-control col-md-7 col-xs-12 has-feedback-left"
                                               id="autorizacion" name="autorizacion" required="required" type="text">
                                        <span class="fa fa-hashtag form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-4 col-xs-12">Tipo de Venta :</label>
                                    <div class="col-md-3 col-xs-12">
                                        <select style="border-radius: 5px" class="form-control has-feedback-left"
                                                name="tipoventa" id="tipoventa">
                                            <option value="CONTADO">CONTADO</option>
                                            <option value="CREDITO">CRÉDITO</option>
                                        </select>
                                        <span class="fa fa-money form-control-feedback left" aria-hidden="true"></span>
                                    </div>


                                    <label class="control-label col-md-2 col-xs-12">Tiempo:</label>
                                    <div class="col-md-3 col-xs-12">
                                        <input style="border-radius: 5px; text-align: right "
                                               class="form-control has-feedback-left"
                                               id="dias"
                                               required="required"
                                               type="number"
                                               value="0">
                                        <span class="fa fa-rotate-left form-control-feedback left"
                                              aria-hidden="true"></span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div style="border-radius: 10px" class="x_panel">
                    <div class="x_title">
                        <h2>Detalle Factura</h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <br/>
                        <div class="row">
                            <div class="col-xs-12 table-responsive">
                                <table id="myTable" class="table">
                                    <thead style="background-color: #5A738E;color: whitesmoke">
                                    <th style="text-align: center;width: 100px">Eliminar</th>
                                    <th style="width: 100px">Id</th>
                                    <th style="width: 100px">Cod Ref</th>
                                    <th style="text-align: center; width: 100px">Cantidad</th>
                                    <th>Description</th>
                                    <th style="width: 100px">P. Unit</th>
                                    <th style="width: 100px">IVA</th>
                                    <th style="width: 100px">ICE</th>
                                    <th style="width: 100px">IRBPNR</th>
                                    <th style="width: 100px; text-align: right">Total</th>
                                    </thead>
                                    <tbody>

                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">Subtotal
                                            12%:
                                        </th>
                                        <td class="totales" id="subtotal12">0.00</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">Subtotal 0%
                                            :
                                        </th>
                                        <td class="totales" id="subtotal0">0.00</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">Subtotal Sin
                                            Desc :
                                        </th>
                                        <td class="totales" id="subtotal">0.00</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">Descuento
                                            :
                                        </th>
                                        <td class="totales" id="descuento">0.00</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">IVA (12 %)
                                            :
                                        </th>
                                        <td class="totales" id="iva12">0.00</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">Valor ICE
                                            :
                                        </th>
                                        <td class="totales" id="ice">0.00</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">IRBPNR :
                                        </th>
                                        <td class="totales" id="IRBPNR">0.00</td>
                                    </tr>
                                    <tr>
                                        <td colspan="7" style="border-top: none !important;"></td>
                                        <th colspan="2" style="background-color: #5A738E;color: whitesmoke">VALOR TOTAL
                                            :
                                        </th>
                                        <td class="totales" id="totales">0.00</td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <!-- /.col -->
                        </div>

                        <div class="row">
                            <div class="col-sm-12 col-xs-12" style="text-align: center">
                                <a href="/inventario/registroCompra/0/" class="btn bg-orange">
                                    <i class="glyphicon glyphicon-file"></i> Nueva Compra
                                </a>
                                <button onclick="registrarCompra()" class="btn bg-blue"><i
                                        class="glyphicon glyphicon-save"></i>
                                    Registrar Emt.
                                </button>
                                <button class="btn bg-green" data-toggle="modal"
                                        data-target=".productos">
                                    <i class="glyphicon glyphicon-shopping-cart"></i> Productos (+)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>


    <!-- MODAL PARA CARGAR PROVEEDORES -->
    <div class="modal fadeInLeft" id="proveedores" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="width: 80%">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">Agregar Proveedor a Factura</h4>
                </div>

                <div class="modal-body table-responsive">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div style="border-radius: 10px" class="x_panel">
                                <div class="x_content">
                                    <div class="row">
                                            <table id="tablaProveedor" class="tablaProveedor table-bordered table dataTables_scroll">
                                                <thead style="height:200px; overflow-y: scroll">
                                                <th>Identificación</th>
                                                <th>Nombre</th>
                                                <th>Telefono</th>
                                                <th>Direccion</th>
                                                <th>Email</th>
                                                <th style="text-align: center">Seleccionar</th>
                                                </thead>
                                                <tbody id="body">

                                                {% for proveedor in proveedores %}
                                                    <tr class="cli">
                                                        <td>{{ proveedor.ruc }}</td>
                                                        {% if proveedor.nombreComercial %}
                                                            <td><a href="/inventario/registroCompra/{{ proveedor.id }}/">{{ proveedor.nombreComercial }}</a></td>
                                                        {% else %}
                                                            <td><a href="/inventario/registroCompra/{{ proveedor.id }}/">{{ proveedor.razonSocial }}</a></td>
                                                        {% endif %}
                                                        <td>{{ proveedor.telefono }}</td>
                                                        <td>{{ proveedor.direccion }}</td>
                                                        <td>{{ proveedor.email }}</td>
                                                        <td style="text-align: center ">
                                                            <a href="/inventario/registroCompra/{{ proveedor.id }}/"
                                                               class=" btn bg-green glyphicon glyphicon-user "
                                                               style="font-size: 9px; padding: 3px;margin: 0px"></a>
                                                            </a>
                                                        </td>

                                                    </tr>
                                                {% endfor %}
                                                </tbody>

                                            </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{% url 'registroProveedores' %}" class="btn bg-blue"><i class="fa fa-user-plus"></i>
                        Agregar Proveedor</a>
                    <button type="button" class="btn bg-red" data-dismiss="modal"><i class="fa fa-sign-in"></i>
                        Salir
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- MODAL PARA CARGAR PRODUCTOS -->

    <div class="modal fade productos" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="width: 80%">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span></button>
                    <h4 class="modal-title">Agregar Productos a Factura</h4>
                </div>

                <div class="modal-body table-responsive">
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div style="border-radius: 10px" class="x_panel">
                                <div class="x_content">
                                    <div class="row">
                                            <table id="tablaProductos"
                                                   class="tablaProductos table-bordered table dataTables_scroll">
                                                <thead style="height:200px; overflow-y: scroll">
                                                <th>CODIGO</th>
                                                <th>PRODUCTO</th>
                                                <th style="text-align: center">STOCK</th>
                                                <th>MARCA</th>
                                                <th>PROVEEDOR</th>
                                                <th>PRECIO</th>
                                                <th>IVA</th>
                                                <th style="text-align: right">PVP</th>
                                                <th style="text-align: center">SELECCIONAR</th>
                                                </thead>
                                                <tbody>

                                                {% for producto in productos %}
                                                    <tr id="item{{ producto.id }}">
                                                        <td>{{ producto.producto.cod_referencia }}</td>
                                                        <td>{{ producto.producto.nombre }}</td>
                                                        <td style="text-align: center">{% CalcularStock producto.id %}</td>
                                                        <td>{{ producto.producto.marca.nombre }}</td>
                                                        {% if producto.proveedor.nombreComercial %}
                                                            <td>{{ producto.proveedor.nombreComercial }}</td>
                                                        {% else %}
                                                            <td>{{ producto.proveedor.razonSocial }}</td>
                                                        {% endif %}
                                                        <td style="text-align: right">{{ producto.precioProveedor }}</td>
                                                        <td style="text-align: center">{{ producto.iva }}</td>
                                                        <td style="text-align: right">{{ producto.total }}</td>

                                                        <td style="text-align: center ">
                                                            <a data-ip="{{ producto.id }}"
                                                               data-codigo="{{ producto.producto.cod_referencia }}"
                                                               data-nomb="{{ producto.producto.nombre }}"
                                                               data-precio="{{ producto.precioProveedor }}"
                                                               data-iva="{{ producto.iva }}"
                                                               data-ice="{{ producto.ice }}"
                                                               data-irbpnr="{{ producto.irbpnr }}"
                                                               data-stock="{% CalcularStock producto.id %}"
                                                               data-total="{{ producto.total }}"
                                                               class=" Fila btn bg-green glyphicon glyphicon-ok "
                                                               style="font-size: 9px; padding: 3px;margin: 0px"></a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}

                                                </tbody>

                                            </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <a href="{% url 'registroProductos' %}" class="btn bg-blue"><i
                            class="glyphicon glyphicon-shopping-cart"></i>
                        Agregar Producto</a>
                    <button type="button" class="btn bg-red" data-dismiss="modal"><i class="fa fa-sign-in"></i>Salir
                    </button>
                </div>
            </div>
        </div>
    </div>



    <style>
        .cantidad {
            border: none;
            width: 50px;
            text-align: center;
            font-weight: bold;
            padding-bottom: 0px;
            margin-top: 5px;
        }
    </style>
{% endblock %}
{% block scripts %}

<!-- script para pasar registros del modal a la factura -->
    <script>

        $(document).on('click', '.Fila', function () {
            id = $(this).data('ip');
            codigo = $(this).data('codigo');
            nombre = $(this).data('nomb');
            precioU = $(this).data('precio');
            porcentaje = $(this).data('porcentaje');
            iva = $(this).data('iva');
            ice = $(this).data('ice');
            irbpnr = $(this).data('irbpnr');
            total = $(this).data('total');

            stock = $(this).data('stock');
            cadena = '<tr id="' + id + '"><td style="text-align: center"><button id="' + id + '" class="btn bg-red btn-xs" onclick="remove(this,' + id + ')"><i class="glyphicon glyphicon-trash"></i></button></td><td>' + id + '</td><td>' + codigo + '</td><td style="text-align: center;margin:0px;padding:0px;"><input class="cantidad" onkeyup="capturador(this)" value="1" type="text"></td><td>' + nombre + '</td><td class="unitarios">' + precioU + '<td class="ivas">' + iva + '</td><td class="ices">' + ice + '</td><td class="irbnpr">' + irbpnr + '</td><td class="totales">' + total + '</td></tr>'
                nfilas = $("#myTable>tbody>tr").length;
                if (($(this).data('estado') == 'usado')) {
                    alert('Este item ya lo agrego a la factura. Edite la cantidad')
                } else {
                    $('#myTable>tbody:last').append(cadena)
                    $(this).attr('data-estado', 'usado');
                }
                calculos();
        })
    </script>

    <!-- script para eliminar fila de la factura-->
    <script>
        function remove(t, id) {
            var td = t.parentNode;
            var tr = td.parentNode;
            var table = tr.parentNode;
            console.log($("#item" + id + " .Fila").removeAttr('data-estado'));//Elimina el atributo estado en la tabla productos
            table.removeChild(tr);
            calculos();
        }
    </script>

    <script>
        $(document).on('click', '.Agregar', function () {
            ruc = $(this).data('identificacion');
            rsocial = $(this).data('nombres');
            direccion = $(this).data('direccion');
            telefono = $(this).data('telefono');
            email = $(this).data('email');
            $('#nombrePro').val('rsocial')
            $('#identificacion').val(ruc);
            $('#direccion').val(direccion);
            $('#email').val(email);
            $('#proveedores').modal('hide');
        });
    </script>

    <script>
        var subtotal0 = 0;
        var subtotal12 = 0;
        var subtotal = 0;
        var iva12 = 0;
        var ice = 0;
        var descuento = 0;
        var IRBPNR = 0;
        var grantotal = 0;

        function capturador(t) {
            subtotal0 = subtotal12 = subtotal = iva12 = ice = descuento = IRBPNR = grantotal = 0;
            var td = t.parentNode;
            var tr = td.parentNode;
            var cantidad = ($(tr).find('td input').val())
            var codigo = ($(tr).find('td').eq(1))
            var precioU = parseFloat($(tr).find('td').eq(5).text().replace(",", "."))
            var iva = parseFloat($(tr).find('td').eq(6).text().replace(",", "."))
            var ic = parseFloat($(tr).find('td').eq(7).text().replace(",", "."));
            var ir = parseFloat($(tr).find('td').eq(8).text().replace(",", "."));
            if (iva > 0) {
                subtotal12 = precioU * cantidad;
                iva12 = iva * cantidad;
            }
            else {
                subtotal0 = precioU * cantidad;
                iva12 = 0
            }

            ice = (ic * cantidad);
            IRBPNR = (ir * cantidad);
            total = (precioU + iva + ic + ir) * cantidad;
            console.log(cantidad + " " + precioU + " total: " + total);
            $(tr).find('td').eq(9).text(total.toFixed(2))
            calculos()
        }

        function calculos() {
            subtotal0 = subtotal12 = subtotal = iva12 = ice = descuento = IRBPNR = grantotal = 0;
            $("#myTable>tbody>tr").each(function () {
                var cantidades = parseFloat($(this).find('td input').val().replace(",", "."));
                var unitarios = parseFloat($(this).find('td').eq(5).text().replace(",", "."));
                var ivas = parseFloat($(this).find('td').eq(6).text().replace(",", "."));
                var ices = parseFloat($(this).find('td').eq(7).text().replace(",", "."));
                var irbnpr = parseFloat($(this).find('td').eq(8).text().replace(",", "."));
                if (ivas > 0) {
                    subtotal12 += unitarios * cantidades;
                    iva12 += (ivas * cantidades);
                }
                else {
                    subtotal0 += unitarios * cantidades;
                }
                ice += (ices * cantidades);
                IRBPNR += (irbnpr * cantidades);
            })
            subtotal = subtotal12 + subtotal0;
            $("#subtotal12").text(subtotal12.toFixed(2));
            $("#subtotal0").text(subtotal0.toFixed(2));
            $("#subtotal").text(subtotal.toFixed(2))
            $("#iva12").text(iva12.toFixed(2));
            $("#ice").text(ice.toFixed(2));
            $("#IRBPNR").text(IRBPNR.toFixed(2));
            grantotal = subtotal + iva12 + ice + IRBPNR
            $("#totales").text(grantotal.toFixed(2));
            console.log("Calculos: sub12: " + subtotal12.toFixed(2) + " sub0: " + subtotal0.toFixed(2) + " iva12: " + iva12.toFixed(2))
        }

    </script>

    <script>
        function registrarCompra() {
            var idproveedor = $("#idproveedor").val();
            var sub0 = $("#subtotal0").text();
            var sub12 = $("#subtotal12").text();
            var sub = $("#subtotal").text();
            var ivva = $("#iva12").text();
            var iceee = $("#ice").text();
            var irbpnrrr = $("#IRBPNR").text();
            var totalesss = $("#totales").text();
            var fecha = $("#fechaEmision").val();
            var autorizaciondoc = $("#autorizacion").val();
            var secuencial = $("#secuencial").val();
            var dias= $("#dias").val();
            var tipoventa=$("#tipoventa").val();
            var tipo=$("#tipo").val();
            var f = $("#myTable>tbody>tr").length;
            if (f > 0) {
                $.post("/inventario/registroCompra/" + idproveedor + "/", {
                    'tipoventa':tipoventa,
                    'dias':dias,
                    'tipo':tipo,
                    'proveedor': parseInt(idproveedor),
                    'sutotal0': parseFloat(sub0),
                    'subtotal12': parseFloat(sub12),
                    'subtotal': parseFloat(sub),
                    'iva': parseFloat(ivva),
                    'ice': parseFloat(iceee),
                    'irbpnr': parseFloat(irbpnrrr),
                    'total': parseFloat(totalesss),
                    'fechaEmision': fecha,
                    'autorizacion': autorizaciondoc,
                    'secuencial': secuencial,
                }, function (data) {
                    if (parseInt(data) > 0) {
                        registroDetalles(data)
                    }
                    console.log(data)
                });
                $("#agregaProductos").attr('disabled', 'disabled')
            }
            else {
                alert("La factura esta en blanco")
            }
        }

        var idFact = 0

        function registroDetalles(data) {
            var subtotal0 = 0;
            var subtotal12 = 0;
            var subtotal = 0;
            var iva12 = 0;
            var ice = 0;
            var IRBPNR = 0;
            var nf = $("#myTable>tbody>tr").length;
            $("#myTable>tbody>tr").each(function () {
                subtotal0 = subtotal12 = subtotal = iva12 = ice = IRBPNR = 0;
                var producto = $(this).find('td').eq(1).text();
                var cantidades = parseFloat($(this).find('td input').val().replace(",", "."));
                var unitarios = parseFloat($(this).find('td').eq(5).text().replace(",", "."));
                var ivas = parseFloat($(this).find('td').eq(6).text().replace(",", "."));
                var ices = parseFloat($(this).find('td').eq(7).text().replace(",", "."));
                var irbnpr = parseFloat($(this).find('td').eq(8).text().replace(",", "."));
                if (ivas > 0) {
                    subtotal12 += unitarios * cantidades;
                    iva12 += (ivas * cantidades);
                }
                else {
                    subtotal0 += unitarios * cantidades;
                }
                subtotal = subtotal0 + subtotal12;
                ice += (ices * cantidades);
                IRBPNR += (irbnpr * cantidades);
                idFact = data;
                $.post("/inventario/Compra/" + data + "/", {
                    compra_id: parseInt(data),
                    producto: producto,
                    cantidad: cantidades,
                    sub0: subtotal0,
                    sub12: subtotal12,
                    sub: subtotal,
                    iva: iva12,
                    ice: ice,
                    Irbpnr: IRBPNR,
                    total: total
                }, function (data) {
                    if (data == "ok") {
                        nf -= 1;
                        console.log("Se registró la fila..!!  -> " + nf)
                        if(nf==0){
                            alert('La compra se guardo..!!')
                        }
                    }
                    else {
                        console.log("Error en el servidor..!!")

                    }

                });
            });
        }

    </script>
    <!-- script para filtrar datos del los modales-->
    <script>
    Tablas('#tablaProveedor');
    Tablas('#tablaProductos');
    </script>

{% endblock %}